resolver 10.55.53.10;
lua_code_cache off;

upstream master {
    server www.qa.groundlink.us:81;
}

upstream beta {
    server tomcat1.qa.towncar.us:8084;
    #server www2.qa.groundlink.us:80;
}
upstream master_ssl {
    server www.qa.groundlink.us:81;
}

upstream beta_ssl {
    server tomcat1.qa.towncar.us:8084;
    #server www2.qa.groundlink.us:80;
}

upstream redis {
  server stream1.qa.towncar.us:6379; # Shrink to fit
  keepalive 1024 single;
}



server {
    listen       50.97.194.110:80;
    server_name  www.qa.groundlink.us;
    # server_name www.groundlink.dev; 
    # listen 80;

    error_log /var/log/nginx/groundlink.dev.log info;
    
	set $root_path /usr/local/openresty/lualib/cpanel;
    set $staging "developmenet";
    # We want to match any request which starts with a username. The brackets capture the username automatically in the Nginx variable $1:
    location / {
        set $ab_backend "master";
        set $ab_hostname "www.qa.groundlink.us";

        
        # Any proxy configuration we need, and other Nginx config if required.

        if (-f $request_filename ) {
          break;
        }
        # Google, Yahoo and other bots need to go to master release
        if ($http_user_agent ~* '(yandex|baidu|gigabot|googlebot|libwww-perl|lwp-trivial|orangeask|flebot|mj12bot|surveybot|baiduspider|msnbot|bingbot|adidxbot|aihitbot|siteuptime|slurp|wordpress|zibb|zyborg|yahoo! slurp)'){
            proxy_pass http://master;
            break;
        }

        rewrite_by_lua_file /usr/local/openresty/ab_nginx_proxy/config/ab_testing.lua;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $ab_hostname;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_pass http://$ab_backend;
        
    }
}

server {
    listen       50.97.194.110:443 ssl;
    server_name  www.qa.groundlink.us;
    # listen 443 default_server ssl;
    # server_name www.groundlink.dev; 
    
    ssl_certificate      /var/www/vhost/groundlink.com/ssl/qa.groundlink.us.crt;
    ssl_certificate_key  /var/www/vhost/groundlink.com/ssl/nginx.qa.groundlink.us.key;

    error_log /var/log/nginx/groundlink.dev.log info;
    
    set $root_path /usr/local/openresty/lualib/cpanel;
    
    location ~ ^/admin/api/ {
        allow 192.168.0.0/16;
        allow 65.204.14.54/32;
        allow 17.16.0.0/16;
        allow 127.0.0.1/32;
        deny all;
        default_type application/json;
        
        content_by_lua_file $root_path/services.lua;
    }


    location ~ ^/admin/ {
        allow 192.168.0.0/16;
        allow 65.204.14.54/32;
        allow 17.16.0.0/16;
        allow 127.0.0.1/32;
        deny all;
        default_type text/html;
        root $root_path;

        if (-f $request_filename ) {
            rewrite ^ $uri break;
        }
    }
    
    # We want to match any request which starts with a username. The brackets capture the username automatically in the Nginx variable $1:
    location / {
        set $ab_backend "master";
        set $ab_hostname "www.qa.groundlink.us";

        
        # Any proxy configuration we need, and other Nginx config if required.

        if (-f $request_filename ) {
          break;
        }
        # Google, Yahoo and other bots need to go to master release
        if ($http_user_agent ~* '(yandex|baidu|gigabot|googlebot|libwww-perl|lwp-trivial|orangeask|flebot|mj12bot|surveybot|baiduspider|msnbot|bingbot|adidxbot|aihitbot|siteuptime|slurp|wordpress|zibb|zyborg|yahoo! slurp)'){
            proxy_pass http://master;
            break;
        }

        rewrite_by_lua_file /usr/local/openresty/ab_nginx_proxy/config/ab_testing.lua;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $ab_hostname;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto https;
        
        proxy_pass http://$ab_backend"_ssl";
        proxy_redirect  off;
        
    }
}

